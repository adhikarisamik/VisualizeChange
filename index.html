<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Nepal Earthquake</title>
    <h3><i>Nepal Earthquake</i></h3>
    <link type="text/css" href="dcnew/web/css/leaflet.css" rel="stylesheet"/>
    <link type="text/css" href="dcnew/web/css/dc.css" rel="stylesheet"/>
</head>


<div id="holder">
    <div id="mymap" class="map" style="width:25%; height:200px;"></div>
    <div id="org" class="bub" style="width:50%; height:650px;"></div>
    <div id="row" class="row" style="width:25%; height:200px;"></div>
    <div id="pie" class="pie" style="width:25%; height:250px;"></div>
</div>

    <script type="text/javascript" src="dcnew/web/js/d3.js"></script>
    <script type="text/javascript" src="dcnew/web/js/crossfilter.js"></script>
    <script type="text/javascript" src="dcnew/web/js/dc.js"></script>
    <script type="text/javascript" src="dcnew/web/js/leaflet.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.js"></script>
    <script type="text/javascript" src="dcnew/dc.leaflet.js"></script>
    <script type="text/javascript" src="dcnew/src/bubble-cloud.js"></script>

    <script type="text/javascript">


    d3.csv("data/nepalearthquake.csv", function (csv) {



        var data = crossfilter(csv);

        var numberFormat = d3.format(".2f");
        var group = "Choropleth";
        var nepChart = dc_leaflet.choroplethChart("#holder .map", group);
        var orgChart = dc.rowChart("#holder .row",group)
        var bubblecloud = dc.bubbleCloud("#holder .bub", group);


        var district = data.dimension(function (d) {
            return d["district2"];
        });

        var districtgroup = district.group().reduceCount();

        var deathSum = district.group().reduce(reduceAdd, reduceRemove, reduceInitial);

        var sector = data.dimension(function (d) {
            return d["sector"];
        });

        var sectorgroup = sector.group().reduceCount();

        var org = data.dimension(function (d) {
            return d["org_acro"];
        });

        var orggroup = org.group().reduceCount();

        function reduceAdd(p, v) {
            p.total += +v.death;
            p.total2 += +v.injuries;
            p.total3 += +v.houses;
            ++p.count;
            p.average = d3.round((p.total / p.count), 2);
            p.average2 = d3.round((p.total2 / p.count), 2);
            p.average3 = d3.round((p.total3 / p.count), 2);
            return p;
        }

        function reduceRemove(p, v) {
            p.total -= +v.death;
            p.total2 -= +v.injuries;
            p.total3 -= +v.houses;
            --p.count;
            p.average = d3.round((p.total / p.count), 2);
            p.average2 = d3.round((p.total2 / p.count), 2);
            p.average3 = d3.round((p.total3 / p.count), 2);
            return p;
        }

        function reduceInitial(p, v) {
            return {
                total: 0,
                total2: 0,
                total3: 0,
                count: 0,
                average: 0,
                average2: 0,
                average3: 0
            };
        }


        d3.json("nepal-districts.geojson", function (d, districtJson) {
            nepChart
                    .center([27.8,85.3])
                    .zoom(7)
                    .dimension(district)
                    .group(deathSum)
                    .valueAccessor(function(p) { return p.value.count > 0 ? p.value.average : 0;})
                    .colors(d3.scale.quantize().range(["#fee0d2", "#fb6a4a", "#ef3b2c", "#cb181d", "#a50f15", "#67000d"]))
                    .colorDomain([0, 3553])
                    .colorAccessor(function(d) {
                        return d.value.average;
                    })
                    .geojson(districtJson.features)
                    .featureKeyAccessor(function (feature) {
                        return feature.properties.DISTRICT;
                    })
                    .renderPopup(true)
                    .popup(function (d) {
                        return "District: " + d.key
                                + "<br/> Total Death: " + d.value.average;

                    });



            bubblecloud
                    .dimension(org)
                    .group(orggroup)
                    .x(d3.scale.ordinal())
                    .r(d3.scale.linear())
                    .radiusValueAccessor(function(d) {
                        return 0.00015* d.value;
                    })
                    .colors(d3.scale.ordinal().range(["#2171b5", "#9ecae1", "#deebf7"]))
                    .colorAccessor(function(d) {
                        return d.value;
                    })
                    .label(function(d) {
                        return d.key;
                    })
                    .renderLabel(true)
                    .title(function(d) {
                        return d.key + ': ' + d.value;
                    })
                    .renderTitle(true)



            orgChart
                    .dimension(sector)
                    .group(sectorgroup)
                    .renderTitle(true)
                    .colors(d3.scale.ordinal().range(["#2171b5", "#9ecae1", "#deebf7"]))
                    .label(function (d){
                        return d.key;
                    })
                    .title(function(d){return d.value;})
                    .elasticX(true)
                    .xAxis().ticks(4)





            orgChart.ordering(function(d) { return -d.value })



            dc.renderAll(group);



        });

    });



</script>
</body>
</html>
